branches:
  only:
  - master
services: 
- docker
push: &push
      before_install:
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        - |
          sudo add-apt-repository "$(echo "deb [arch=amd64] \
          	https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
          	| tr -d '\t')"
        - sudo apt-get update
        - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
        - docker version
      after_success:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker images
        - |
          for i in `docker images --format {{.Repository}}:{{.Tag}}`; do
          	if [[ $TRAVIS_EVENT_TYPE == "push" ]]; then 
          		docker push $i;
          	fi
          done
alpine: &alpine
      stage: Build
      os: linux
      language: shell
      script:
        - docker-compose -f $COMPOSE_FILE build
        - docker rmi alpine:3.11
        - IMAGE=$(docker images | tail -1 | awk '{print $1}')
        - TAG=$(docker images | tail -1 | awk '{print $2}')
        - docker tag ${IMAGE}:${TAG} ${IMAGE}:${TAG}-${TRAVIS_COMMIT:0:7}
        - docker system prune -f
      <<: *push
debian: &debian
      stage: Build
      os: linux
      language: shell
      script:
        - docker-compose -f $COMPOSE_FILE build
        - docker rmi debian:9.12-slim
        - IMAGE=$(docker images | tail -1 | awk '{print $1}')
        - TAG=$(docker images | tail -1 | awk '{print $2}')
        - docker tag ${IMAGE}:${TAG} ${IMAGE}:${TAG}-${TRAVIS_COMMIT:0:7}
        - |
          [ "$PY_VER" == "3.8" ] && docker tag ${IMAGE}:${TAG} ${IMAGE}:latest || echo
        - docker system prune -f
      <<: *push
jobs:
  include:
    - <<: *alpine
      env:
      - LABEL: alpine
      - PY_VER: 3.9
      - CONDA_VER: 4.9.0
      - PY_LABEL: py38_
      - CONDA_MD5: d63adf39f2c220950a063e0529d4ff74
      - COMPOSE_FILE: dist/alpine/docker-compose.yml
    - <<: *alpine
      env:
      - LABEL: alpine
      - PY_VER: 3.8
      - CONDA_VER: 4.8.3
      - PY_LABEL: py38_
      - CONDA_MD5: d63adf39f2c220950a063e0529d4ff74
      - COMPOSE_FILE: dist/alpine/docker-compose.yml
    - <<: *alpine
      env:
      - LABEL: alpine
      - PY_VER: 3.7
      - CONDA_VER: 4.8.3
      - PY_LABEL: py37_
      - CONDA_MD5: 751786b92c00b1aeae3f017b781018df
      - COMPOSE_FILE: dist/alpine/docker-compose.yml
    - <<: *alpine
      env:
      - LABEL: alpine
      - PY_VER: 3.6
      - CONDA_VER: 4.5.4
      - CONDA_MD5: a946ea1d0c4a642ddf0c3a26a18bb16d
      - COMPOSE_FILE: dist/alpine/docker-compose.yml
    - <<: *debian
      env:
      - LABEL: debian
      - PY_VER: 3.9
      - CONDA_VER: 4.9.0
      - PY_LABEL: py38_
      - COMPOSE_FILE: dist/debian/docker-compose.yml
    - <<: *debian
      env:
      - LABEL: debian
      - PY_VER: 3.8
      - CONDA_VER: 4.8.3
      - PY_LABEL: py38_
      - COMPOSE_FILE: dist/debian/docker-compose.yml
    - <<: *debian
      env:
      - LABEL: debian
      - PY_VER: 3.7
      - CONDA_VER: 4.8.3
      - PY_LABEL: py37_
      - COMPOSE_FILE: dist/debian/docker-compose.yml
    - <<: *debian
      env:
      - LABEL: debian
      - PY_VER: 3.6
      - CONDA_VER: 4.4.10
      - COMPOSE_FILE: dist/debian/docker-compose.yml